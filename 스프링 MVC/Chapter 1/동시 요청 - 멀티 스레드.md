# HTTP 요청

요청이 왔을 때 WAS 안에서 서블릿이 호출되는 건 이해함

**근데 누가 호출해???????????**

# 스레드(Thread)

- 애플리케이션 코드를 하나하나 순차적으로 실행하는 것이 스레드
- 자바의 `main` 메서드를 실행하면 main이라는 이름의 스레드가 실행됨
- 스레드가 없다 -> 자바 애플리케이션 실행이 불가
- 스레드는 한번에 하나의 코드 라인만 실행

**동시 처리가 필요하다 = 스레드가 더 필요하다**

# 단일 요청 - 스레드 1개

요청이 온다 -> WAS가 스레드를 할당 -> 스레드가 서블릿 코드 실행

# 다중 요청 - 스레드 1개

요청1이 온다 -> 똑같이 수행 -> 만약 처리가 지연된다면?
-> 다음으로 오는 요청2는 대기해야함 -> 둘 다 타임아웃!

# 요청 마다 스레드 생성된다면

- 장점
	- 동시 요청 처리 가능
	- 리소스가 허용할 때까지 처리 가능
	- 하나의 스레드 지연될 때도 영향X
- 단점
	- 스레드 생성 비용은 비싸다 -> 응답 속도 저하
	- Context 스위칭 비용 발생한다(코어 하나가 2개의 스레드를 오가면서 실행하는 비용) 
	- 스레드 생성에 제한이 없다 -> 하드웨어 임계점을 넘어버릴 수 있다

# 스레드 풀

요청들이 오면 스레드 풀로 스레드 요청해서 갖다 쓰기(개수 제한)
사용 후 스레드 풀에 스레드를 반납

사전에 정의된 제한 개수를 넘어선 요청이 온 경우, 스레드 대기/거절

- 특징
	- 필요한 스레드를 풀에 보관하고 관리
	- 생성 가능한 스레드의 최대치 관리 (톰캣은 최대 200개가 기본, 변경 가능)
- 사용
	- 스레드가 필요하면, 이미 생성된 스레드를 풀에서 꺼내 사용
	- 사용 종료 시, 풀에 스레드 반납
	- 스레드가 없으면 -> 요청 거절 또는 특정 숫자만큼만 대기 시킬 수 있음

- 장점
	- 스레드가 미리 생성되어 있으므로, 스레드 생성/종료 비용(CPU) 절약, 응답 시간 빠름
	- 생성 가능한 스레드 개수의 제한이 있어, 많은 요청이 들어와도 기존 요청은 안전하게 처리

- WAS의 주요 튜닝 포인트는 최대 스레드 수이다
	- 너무 낮으면 -> 리소스가 여유롭지만 하드웨어(CPU) 가용률이 너무 낮아 응답 지연이 생김
	- 너무 높으면 -> 하드웨어 임계점 초과로 서버가 다운될 수 있음
	- 클라우드면 서버 늘리고 튜닝, 아니면 튜닝만 열심히
	- 적정 숫자는? - 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 모두 다름
	- 성능 테스트 - 최대한 실제 서비스와 유사하게 성능 테스트 해보기 (nGrinder)

# WAS의 멀티 스레드 지원(핵심)

- 멀티 스레드 부분은 WAS가 처리
- **개발자가 멀티 스레드 관련 코드를 신경쓰지 않아도 됨!**
- 싱글 스레드 프로그래밍 하듯이 편리하게 소스코드 개발
- 멀티 스레드 환경 -> 싱글톤 객체(서블릿, 스프링 빈)는 주의!





